# å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ - WebSocketå®æ—¶é€šçŸ¥ä¸JWTè®¤è¯å®ç°æŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æŠ¥å‘Šè¯¦ç»†è®°å½•äº†ä¸ºå›¾ä¹¦ç®¡ç†ç³»ç»Ÿæ·»åŠ WebSocketå®æ—¶é€šçŸ¥åŠŸèƒ½å’ŒJWTè®¤è¯ç³»ç»Ÿçš„å®Œæ•´å®ç°è¿‡ç¨‹ã€‚

### ğŸ¯ é¡¹ç›®ç›®æ ‡
- å®ç°JWTç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- å¼€å‘WebSocketå®æ—¶é€šçŸ¥åŠŸèƒ½
- æ·»åŠ æ–°ä¹¦åˆ°è¾¾ã€å€Ÿé˜…æé†’ç­‰é€šçŸ¥
- æ„å»ºç³»ç»Ÿæ¶ˆæ¯æ¨é€æ¨¡å—

### ğŸ—ï¸ æŠ€æœ¯æ ˆ
- **åç«¯æ¡†æ¶**: Spring Boot 3.4.5
- **å®‰å…¨æ¡†æ¶**: Spring Security
- **WebSocket**: Spring WebSocket + STOMP
- **JWT**: JJWT 0.12.3
- **æ•°æ®åº“**: MySQL + JPA
- **å‰ç«¯**: HTML + JavaScript + SockJS + STOMP.js

---

## ğŸ”§ å®ç°çš„åŠŸèƒ½æ¨¡å—

### 1. JWTè®¤è¯ç³»ç»Ÿ

#### ğŸ“¦ æ·»åŠ çš„ä¾èµ–
```xml
<!-- JWT dependencies -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.12.3</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.12.3</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.12.3</version>
    <scope>runtime</scope>
</dependency>
```

#### ğŸ“ åˆ›å»ºçš„æ ¸å¿ƒæ–‡ä»¶
- `src/main/java/me/myot233/booksystem/util/JwtUtil.java` - JWTå·¥å…·ç±»
- `src/main/java/me/myot233/booksystem/security/JwtAuthenticationFilter.java` - JWTè®¤è¯è¿‡æ»¤å™¨
- æ›´æ–° `SecurityConfig.java` - é›†æˆJWTåˆ°Spring Security
- æ›´æ–° `AuthController.java` - ç™»å½•è¿”å›JWT token

#### ğŸ” å®ç°åŸç†
```java
// 1. ç”¨æˆ·ç™»å½•æ—¶ç”ŸæˆJWT token
String token = jwtUtil.generateTokenWithRole(userDetails, user.getRole());
String refreshToken = jwtUtil.generateRefreshToken(userDetails);

// 2. æ¯æ¬¡è¯·æ±‚é€šè¿‡è¿‡æ»¤å™¨éªŒè¯token
if (jwtUtil.validateToken(jwtToken, userDetails)) {
    UsernamePasswordAuthenticationToken authToken =
        new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
    SecurityContextHolder.getContext().setAuthentication(authToken);
}
```

#### âš™ï¸ JWTé…ç½®
```properties
# JWT Configuration
jwt.expiration=86400000          # 24å°æ—¶
jwt.refresh-expiration=604800000 # 7å¤©
```

### 2. WebSocketå®æ—¶é€šçŸ¥ç³»ç»Ÿ

#### ğŸ“ åˆ›å»ºçš„æ ¸å¿ƒæ–‡ä»¶
- `src/main/java/me/myot233/booksystem/config/WebSocketConfig.java` - WebSocketé…ç½®
- `src/main/java/me/myot233/booksystem/controller/WebSocketController.java` - WebSocketæ¶ˆæ¯æ§åˆ¶å™¨
- `src/main/java/me/myot233/booksystem/entity/Notification.java` - é€šçŸ¥å®ä½“ç±»
- `src/main/java/me/myot233/booksystem/repository/NotificationRepository.java` - é€šçŸ¥æ•°æ®è®¿é—®å±‚
- `src/main/java/me/myot233/booksystem/service/NotificationService.java` - é€šçŸ¥ä¸šåŠ¡é€»è¾‘
- `src/main/java/me/myot233/booksystem/controller/NotificationController.java` - é€šçŸ¥REST API

#### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„
```
å®¢æˆ·ç«¯ â†â†’ WebSocket â†â†’ STOMPåè®® â†â†’ Springæ¶ˆæ¯ä»£ç† â†â†’ ä¸šåŠ¡æœåŠ¡
```

#### ğŸ“¡ æ¶ˆæ¯é¢‘é“è®¾è®¡
- `/topic/system-notifications` - ç³»ç»Ÿå¹¿æ’­ï¼ˆæ‰€æœ‰ç”¨æˆ·ï¼‰
- `/topic/new-books` - æ–°ä¹¦é€šçŸ¥ï¼ˆæ‰€æœ‰ç”¨æˆ·ï¼‰
- `/user/queue/notifications` - ä¸ªäººé€šçŸ¥ï¼ˆç‰¹å®šç”¨æˆ·ï¼‰
- `/user/queue/unread-count` - æœªè¯»æ•°é‡ï¼ˆç‰¹å®šç”¨æˆ·ï¼‰

#### ğŸ”§ WebSocketé…ç½®
```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/topic", "/queue");
        config.setApplicationDestinationPrefixes("/app");
        config.setUserDestinationPrefix("/user");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws")
                .setAllowedOriginPatterns("*")
                .withSockJS();
    }
}
```

### 3. é€šçŸ¥åŠŸèƒ½æ¨¡å—

#### ğŸ“Š æ•°æ®åº“è®¾è®¡
```sql
-- é€šçŸ¥è¡¨
CREATE TABLE notifications (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    type VARCHAR(50) NOT NULL,
    is_read BOOLEAN DEFAULT FALSE,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    book_id BIGINT
);
```

#### ğŸ·ï¸ é€šçŸ¥ç±»å‹æšä¸¾
```java
public enum NotificationType {
    NEW_BOOK("æ–°ä¹¦åˆ°è¾¾"),
    BORROW_REMINDER("å€Ÿé˜…æé†’"),
    RETURN_REMINDER("å½’è¿˜æé†’"),
    OVERDUE_REMINDER("é€¾æœŸæé†’"),
    SYSTEM_MESSAGE("ç³»ç»Ÿæ¶ˆæ¯"),
    BOOK_AVAILABLE("å›¾ä¹¦å¯å€Ÿ");
}
```

#### ğŸš€ æ ¸å¿ƒåŠŸèƒ½å®ç°

**1. æ–°ä¹¦åˆ°è¾¾é€šçŸ¥**
```java
// åœ¨BookControllerä¸­ï¼Œæ·»åŠ æ–°ä¹¦æ—¶è§¦å‘
@PostMapping
public ResponseEntity<Book> addBook(@RequestBody Book book) {
    Book savedBook = bookService.saveBook(book);
    // å‘é€æ–°ä¹¦åˆ°è¾¾é€šçŸ¥
    notificationService.sendNewBookNotification(savedBook.getTitle(), savedBook.getId());
    return new ResponseEntity<>(savedBook, HttpStatus.CREATED);
}
```

**2. å®æ—¶æ¶ˆæ¯æ¨é€**
```java
// é€šè¿‡WebSocketå‘é€å®æ—¶é€šçŸ¥
public void sendRealTimeNotification(Long userId, Notification notification) {
    messagingTemplate.convertAndSendToUser(
        userId.toString(),
        "/queue/notifications",
        notification
    );

    // åŒæ—¶å‘é€æœªè¯»é€šçŸ¥æ•°é‡
    long unreadCount = getUnreadNotificationCount(userId);
    messagingTemplate.convertAndSendToUser(
        userId.toString(),
        "/queue/unread-count",
        unreadCount
    );
}
```

**3. ç³»ç»Ÿå¹¿æ’­**
```java
// ç®¡ç†å‘˜å‘é€ç³»ç»Ÿå¹¿æ’­
public void broadcastSystemNotification(String title, String content) {
    Notification notification = new Notification();
    notification.setTitle(title);
    notification.setContent(content);
    notification.setType(NotificationType.SYSTEM_MESSAGE);

    messagingTemplate.convertAndSend("/topic/system-notifications", notification);
}
```

### 4. å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ

#### ğŸ“ åˆ›å»ºçš„æ–‡ä»¶
- `src/main/java/me/myot233/booksystem/service/ScheduledNotificationService.java` - å®šæ—¶é€šçŸ¥æœåŠ¡
- æ›´æ–° `BookSystemApplication.java` - å¯ç”¨å®šæ—¶ä»»åŠ¡

#### â° å®šæ—¶ä»»åŠ¡åŠŸèƒ½
```java
// æ¯å¤©ä¸Šåˆ9ç‚¹æ£€æŸ¥å€Ÿé˜…åˆ°æœŸ
@Scheduled(cron = "0 0 9 * * ?")
public void checkBorrowingDueDates() {
    List<User> users = userRepository.findAll();
    for (User user : users) {
        List<Book> borrowedBooks = user.getBorrowedBooks();
        for (Book book : borrowedBooks) {
            // æ£€æŸ¥å€Ÿé˜…åˆ°æœŸæƒ…å†µï¼Œå‘é€æé†’
            notificationService.sendReturnReminder(
                user.getId(), book.getTitle(), book.getId(), 3);
        }
    }
}

// æ¯å°æ—¶æ£€æŸ¥é€¾æœŸæƒ…å†µ
@Scheduled(cron = "0 0 * * * ?")
public void checkOverdueBooks() {
    // æ£€æŸ¥é€¾æœŸå›¾ä¹¦ï¼Œå‘é€é€¾æœŸæé†’
}

// æ¯å‘¨æ—¥æ™šä¸Š8ç‚¹å‘é€ç³»ç»Ÿç»´æŠ¤é€šçŸ¥
@Scheduled(cron = "0 0 20 * * SUN")
public void sendWeeklyMaintenance() {
    notificationService.broadcastSystemNotification(
        "ç³»ç»Ÿç»´æŠ¤é€šçŸ¥",
        "ç³»ç»Ÿå°†äºæœ¬å‘¨æ—¥æ™šä¸Š22:00-24:00è¿›è¡Œä¾‹è¡Œç»´æŠ¤ã€‚"
    );
}
```

### 5. ç³»ç»Ÿä¿¡æ¯æ¥å£

#### ğŸ“ åˆ›å»ºçš„æ–‡ä»¶
- `src/main/java/me/myot233/booksystem/controller/HomeController.java` - ç³»ç»Ÿä¿¡æ¯æ§åˆ¶å™¨

#### ğŸ¨ ç³»ç»Ÿæ¥å£åŠŸèƒ½
- ç³»ç»ŸçŠ¶æ€ä¿¡æ¯
- APIç«¯ç‚¹åˆ—è¡¨
- å¥åº·æ£€æŸ¥æ¥å£
- æµ‹è¯•è´¦æˆ·ä¿¡æ¯

#### ğŸ’» WebSocketå®¢æˆ·ç«¯è¿æ¥ç¤ºä¾‹
```javascript
// è¿æ¥WebSocket
const socket = new SockJS('/ws');
const stompClient = Stomp.over(socket);

// ä½¿ç”¨JWT tokenè¿æ¥
const headers = {
    'Authorization': 'Bearer ' + jwtToken
};

stompClient.connect(headers, function(frame) {
    // è®¢é˜…ä¸ªäººé€šçŸ¥
    stompClient.subscribe('/user/queue/notifications', function(message) {
        const notification = JSON.parse(message.body);
        handleNotification(notification);
    });

    // è®¢é˜…ç³»ç»Ÿå¹¿æ’­
    stompClient.subscribe('/topic/system-notifications', function(message) {
        const notification = JSON.parse(message.body);
        handleSystemMessage(notification);
    });
});
```

---

## ğŸ”„ ç³»ç»Ÿæµç¨‹

### 1. JWTè®¤è¯æµç¨‹
```
1. ç”¨æˆ·ç™»å½• â†’ éªŒè¯ç”¨æˆ·åå¯†ç 
2. ç”ŸæˆJWT token â†’ åŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²
3. è¿”å›tokenç»™å®¢æˆ·ç«¯
4. å®¢æˆ·ç«¯è¯·æ±‚æºå¸¦token â†’ Authorization: Bearer <token>
5. JWTè¿‡æ»¤å™¨éªŒè¯token â†’ è®¾ç½®Spring Securityä¸Šä¸‹æ–‡
6. ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ
```

### 2. WebSocketé€šä¿¡æµç¨‹
```
1. å®¢æˆ·ç«¯è¿æ¥ â†’ SockJS + STOMPåè®®
2. æœåŠ¡ç«¯é…ç½®æ¶ˆæ¯ä»£ç† â†’ /topic, /queue, /userå‰ç¼€
3. å®¢æˆ·ç«¯è®¢é˜…é¢‘é“ â†’ æ¥æ”¶ç‰¹å®šç±»å‹æ¶ˆæ¯
4. æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ â†’ é€šè¿‡SimpMessagingTemplate
5. å®¢æˆ·ç«¯æ¥æ”¶æ¶ˆæ¯ â†’ å®æ—¶æ˜¾ç¤ºé€šçŸ¥
```

### 3. é€šçŸ¥æ¨é€æµç¨‹
```
1. ä¸šåŠ¡äº‹ä»¶è§¦å‘ â†’ æ–°ä¹¦æ·»åŠ ã€å€Ÿé˜…åˆ°æœŸç­‰
2. åˆ›å»ºé€šçŸ¥å¯¹è±¡ â†’ ä¿å­˜åˆ°æ•°æ®åº“
3. å®æ—¶æ¨é€ â†’ é€šè¿‡WebSocketå‘é€ç»™ç”¨æˆ·
4. æ›´æ–°æœªè¯»æ•°é‡ â†’ å®æ—¶æ›´æ–°ç”¨æˆ·ç•Œé¢
5. ç”¨æˆ·æ ‡è®°å·²è¯» â†’ æ›´æ–°æ•°æ®åº“çŠ¶æ€
```

---

## ğŸš€ æ–°å¢çš„APIç«¯ç‚¹

### ç³»ç»Ÿä¿¡æ¯ç›¸å…³
- `GET /` - è·å–ç³»ç»Ÿä¿¡æ¯å’ŒAPIåˆ—è¡¨
- `GET /health` - ç³»ç»Ÿå¥åº·æ£€æŸ¥

### è®¤è¯ç›¸å…³
- `POST /api/auth/login` - ç”¨æˆ·ç™»å½•ï¼ˆè¿”å›JWT tokenï¼‰
- `POST /api/auth/register` - ç”¨æˆ·æ³¨å†Œ

### é€šçŸ¥ç›¸å…³
- `GET /api/notifications` - è·å–ç”¨æˆ·æ‰€æœ‰é€šçŸ¥
- `GET /api/notifications/unread` - è·å–æœªè¯»é€šçŸ¥
- `GET /api/notifications/unread/count` - è·å–æœªè¯»é€šçŸ¥æ•°é‡
- `PUT /api/notifications/{id}/read` - æ ‡è®°æŒ‡å®šé€šçŸ¥ä¸ºå·²è¯»
- `PUT /api/notifications/read-all` - æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
- `POST /api/notifications/broadcast` - å‘é€ç³»ç»Ÿå¹¿æ’­ï¼ˆä»…ç®¡ç†å‘˜ï¼‰

### WebSocketç«¯ç‚¹
- `/ws` - WebSocketè¿æ¥ç«¯ç‚¹

---

## ğŸ”’ å®‰å…¨é…ç½®æ›´æ–°

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .csrf(AbstractHttpConfigurer::disable)
        .authorizeHttpRequests(authorize -> authorize
            .requestMatchers("/api/auth/**").permitAll()     // å…è®¸è®¤è¯ç›¸å…³è¯·æ±‚
            .requestMatchers("/ws/**").permitAll()           // å…è®¸WebSocketè¿æ¥
            .requestMatchers("/api/books/**").permitAll()    // å…è®¸å›¾ä¹¦ç›¸å…³è¯·æ±‚
            .requestMatchers("/api/users/me").authenticated() // å½“å‰ç”¨æˆ·ä¿¡æ¯éœ€è¦è®¤è¯
            .requestMatchers("/api/users/**").hasRole("ADMIN") // ç”¨æˆ·ç®¡ç†éœ€è¦ç®¡ç†å‘˜æƒé™
            .anyRequest().authenticated()                     // å…¶ä»–è¯·æ±‚éœ€è¦è®¤è¯
        )
        .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
        .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

    return http.build();
}
```

---

## ğŸ¨ åŠŸèƒ½ç‰¹æ€§

### 1. å®æ—¶æ€§
- âœ… WebSocketé•¿è¿æ¥ï¼Œæ¶ˆæ¯å®æ—¶æ¨é€
- âœ… æ— éœ€å®¢æˆ·ç«¯è½®è¯¢ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›
- âœ… æ”¯æŒæ–­çº¿é‡è¿æœºåˆ¶

### 2. å®‰å…¨æ€§
- âœ… JWT tokenè®¤è¯ï¼Œæ— çŠ¶æ€è®¾è®¡
- âœ… ç”¨æˆ·æƒé™æ§åˆ¶ï¼Œç®¡ç†å‘˜æ‰èƒ½å‘é€ç³»ç»Ÿå¹¿æ’­
- âœ… Tokenè¿‡æœŸè‡ªåŠ¨å¤„ç†

### 3. å¯æ‰©å±•æ€§
- âœ… é€šçŸ¥ç±»å‹æšä¸¾ï¼Œæ˜“äºæ·»åŠ æ–°ç±»å‹
- âœ… æ¶ˆæ¯é¢‘é“åˆ†ç¦»ï¼Œæ”¯æŒä¸åŒä¸šåŠ¡åœºæ™¯
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºåŠŸèƒ½æ‰©å±•

### 4. ç”¨æˆ·ä½“éªŒ
- âœ… æœªè¯»æ¶ˆæ¯è®¡æ•°å®æ—¶æ›´æ–°
- âœ… æ¶ˆæ¯å·²è¯»çŠ¶æ€ç®¡ç†
- âœ… ä¸ªæ€§åŒ–é€šçŸ¥æ¨é€
- âœ… æ¶ˆæ¯å†å²è®°å½•æŸ¥è¯¢

### 5. ç³»ç»Ÿç›‘æ§
- âœ… å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ£€æŸ¥
- âœ… ç³»ç»Ÿç»´æŠ¤é€šçŸ¥
- âœ… å€Ÿé˜…åˆ°æœŸæé†’
- âœ… é€¾æœŸå›¾ä¹¦ç›‘æ§

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### 1. å¯åŠ¨åº”ç”¨
```bash
# ä½¿ç”¨Mavenå¯åŠ¨
mvn spring-boot:run

# æˆ–è€…ä½¿ç”¨IDEç›´æ¥è¿è¡ŒBookSystemApplication.java
```

### 2. è®¿é—®æµ‹è¯•é¡µé¢
```
æµè§ˆå™¨è®¿é—®: http://localhost:8080
```

### 3. æµ‹è¯•è´¦æˆ·
- **ç®¡ç†å‘˜è´¦æˆ·**: `admin` / `admin123`
- **æ™®é€šç”¨æˆ·è´¦æˆ·**: `user` / `user123`

### 4. æµ‹è¯•æµç¨‹
1. **ç™»å½•æµ‹è¯•**: ä½¿ç”¨æµ‹è¯•è´¦æˆ·ç™»å½•è·å–JWT token
2. **WebSocketè¿æ¥**: ç‚¹å‡»"è¿æ¥WebSocket"æŒ‰é’®
3. **è®¢é˜…é€šçŸ¥**: è‡ªåŠ¨è®¢é˜…ç›¸å…³é€šçŸ¥é¢‘é“
4. **æ–°ä¹¦é€šçŸ¥**: æ·»åŠ æ–°ä¹¦è§¦å‘å®æ—¶é€šçŸ¥
5. **ç³»ç»Ÿå¹¿æ’­**: ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·å‘é€ç³»ç»Ÿå¹¿æ’­
6. **æ¶ˆæ¯æ¥æ”¶**: æŸ¥çœ‹å®æ—¶æ¶ˆæ¯æ¥æ”¶æƒ…å†µ

### 5. APIæµ‹è¯•
```bash
# ç™»å½•è·å–token
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# è·å–é€šçŸ¥åˆ—è¡¨
curl -X GET http://localhost:8080/api/notifications \
  -H "Authorization: Bearer <your-jwt-token>"

# å‘é€ç³»ç»Ÿå¹¿æ’­
curl -X POST http://localhost:8080/api/notifications/broadcast \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <your-jwt-token>" \
  -d '{"title":"æµ‹è¯•é€šçŸ¥","content":"è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯"}'
```

---

## ğŸ“š APIè°ƒç”¨æ–‡æ¡£

### 1. ç³»ç»Ÿä¿¡æ¯æ¥å£

#### è·å–ç³»ç»Ÿä¿¡æ¯
```bash
GET /
Content-Type: application/json

# å“åº”ç¤ºä¾‹
{
  "service": "å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ API",
  "version": "v1.0.0",
  "status": "running",
  "features": ["JWTè®¤è¯", "WebSocketå®æ—¶é€šçŸ¥", "å›¾ä¹¦ç®¡ç†", "ç”¨æˆ·ç®¡ç†"],
  "endpoints": {
    "GET /api/books": "è·å–å›¾ä¹¦åˆ—è¡¨",
    "POST /api/auth/login": "ç”¨æˆ·ç™»å½•",
    "WebSocket /ws": "å®æ—¶é€šçŸ¥è¿æ¥"
  },
  "testAccounts": {
    "admin": "admin123 (ç®¡ç†å‘˜)",
    "user": "user123 (æ™®é€šç”¨æˆ·)"
  }
}
```

#### å¥åº·æ£€æŸ¥
```bash
GET /health
Content-Type: application/json

# å“åº”ç¤ºä¾‹
{
  "status": "UP",
  "timestamp": 1640995200000,
  "services": {
    "database": "UP",
    "jwt": "UP",
    "websocket": "UP"
  }
}
```

### 2. è®¤è¯ç›¸å…³API

#### ç”¨æˆ·ç™»å½•
```bash
POST /api/auth/login
Content-Type: application/json

# è¯·æ±‚ä½“
{
  "username": "admin",
  "password": "admin123"
}

# å“åº”ç¤ºä¾‹
{
  "message": "ç™»å½•æˆåŠŸ",
  "username": "admin",
  "token": "eyJhbGciOiJIUzUxMiJ9...",
  "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
  "role": "ROLE_ADMIN"
}
```

#### ç”¨æˆ·æ³¨å†Œ
```bash
POST /api/auth/register
Content-Type: application/json

# è¯·æ±‚ä½“
{
  "username": "newuser",
  "password": "password123",
  "realName": "æ–°ç”¨æˆ·",
  "email": "newuser@example.com"
}

# å“åº”ç¤ºä¾‹
{
  "message": "æ³¨å†ŒæˆåŠŸ",
  "username": "newuser"
}
```

### 3. é€šçŸ¥ç›¸å…³API

#### è·å–ç”¨æˆ·æ‰€æœ‰é€šçŸ¥
```bash
GET /api/notifications
Authorization: Bearer <jwt-token>

# å“åº”ç¤ºä¾‹
[
  {
    "id": 1,
    "title": "æ–°ä¹¦åˆ°è¾¾",
    "content": "æ–°ä¹¦ã€Šäººå·¥æ™ºèƒ½å¯¼è®ºã€‹å·²åˆ°è¾¾å›¾ä¹¦é¦†",
    "type": "NEW_BOOK",
    "isRead": false,
    "createTime": "2025-01-25T10:30:00",
    "bookId": 123
  }
]
```

#### è·å–æœªè¯»é€šçŸ¥
```bash
GET /api/notifications/unread
Authorization: Bearer <jwt-token>
```

#### è·å–æœªè¯»é€šçŸ¥æ•°é‡
```bash
GET /api/notifications/unread/count
Authorization: Bearer <jwt-token>

# å“åº”ç¤ºä¾‹
{
  "count": 5
}
```

#### æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
```bash
PUT /api/notifications/{notificationId}/read
Authorization: Bearer <jwt-token>

# å“åº”ç¤ºä¾‹
{
  "message": "æ ‡è®°æˆåŠŸ"
}
```

#### æ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
```bash
PUT /api/notifications/read-all
Authorization: Bearer <jwt-token>

# å“åº”ç¤ºä¾‹
{
  "message": "æ‰€æœ‰é€šçŸ¥å·²æ ‡è®°ä¸ºå·²è¯»"
}
```

#### å‘é€ç³»ç»Ÿå¹¿æ’­ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
```bash
POST /api/notifications/broadcast
Content-Type: application/json
Authorization: Bearer <admin-jwt-token>

# è¯·æ±‚ä½“
{
  "title": "ç³»ç»Ÿç»´æŠ¤é€šçŸ¥",
  "content": "ç³»ç»Ÿå°†äºä»Šæ™š22:00-24:00è¿›è¡Œç»´æŠ¤ã€‚"
}

# å“åº”ç¤ºä¾‹
{
  "message": "ç³»ç»Ÿé€šçŸ¥å‘é€æˆåŠŸ"
}
```

### 4. WebSocketè¿æ¥

#### JavaScriptå®¢æˆ·ç«¯ç¤ºä¾‹
```javascript
// å¼•å…¥ä¾èµ–
// <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
// <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

// è¿æ¥WebSocket
const socket = new SockJS('/ws');
const stompClient = Stomp.over(socket);

// ä½¿ç”¨JWT tokenè¿æ¥
const headers = {
    'Authorization': 'Bearer ' + jwtToken
};

stompClient.connect(headers, function(frame) {
    console.log('å·²è¿æ¥åˆ°WebSocketæœåŠ¡å™¨');

    // è®¢é˜…ä¸ªäººé€šçŸ¥
    stompClient.subscribe('/user/queue/notifications', function(message) {
        const notification = JSON.parse(message.body);
        console.log('æ”¶åˆ°ä¸ªäººé€šçŸ¥:', notification);
        handleNotification(notification);
    });

    // è®¢é˜…æœªè¯»æ•°é‡æ›´æ–°
    stompClient.subscribe('/user/queue/unread-count', function(message) {
        const count = parseInt(message.body);
        console.log('æœªè¯»é€šçŸ¥æ•°é‡:', count);
        updateUnreadCount(count);
    });

    // è®¢é˜…ç³»ç»Ÿå¹¿æ’­
    stompClient.subscribe('/topic/system-notifications', function(message) {
        const notification = JSON.parse(message.body);
        console.log('æ”¶åˆ°ç³»ç»Ÿå¹¿æ’­:', notification);
        handleSystemMessage(notification);
    });

    // è®¢é˜…æ–°ä¹¦é€šçŸ¥
    stompClient.subscribe('/topic/new-books', function(message) {
        const notification = JSON.parse(message.body);
        console.log('æ”¶åˆ°æ–°ä¹¦é€šçŸ¥:', notification);
        handleNewBookNotification(notification);
    });

}, function(error) {
    console.error('WebSocketè¿æ¥å¤±è´¥:', error);
});

// å‘é€å¿ƒè·³æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
function sendHeartbeat() {
    if (stompClient && stompClient.connected) {
        stompClient.send('/app/heartbeat', {}, 'ping');
    }
}

// æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
setInterval(sendHeartbeat, 30000);
```

### 5. é”™è¯¯å¤„ç†

#### å¸¸è§é”™è¯¯å“åº”
```json
# 401 æœªæˆæƒ
{
  "timestamp": "2025-01-25T10:30:00.000+00:00",
  "status": 401,
  "error": "Unauthorized",
  "message": "JWT tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ",
  "path": "/api/notifications"
}

# 403 ç¦æ­¢è®¿é—®
{
  "timestamp": "2025-01-25T10:30:00.000+00:00",
  "status": 403,
  "error": "Forbidden",
  "message": "æƒé™ä¸è¶³",
  "path": "/api/notifications/broadcast"
}

# 404 èµ„æºä¸å­˜åœ¨
{
  "timestamp": "2025-01-25T10:30:00.000+00:00",
  "status": 404,
  "error": "Not Found",
  "message": "èµ„æºä¸å­˜åœ¨",
  "path": "/api/notifications/999"
}
```

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

### 1. æ¶æ„è®¾è®¡
- **å‰åç«¯åˆ†ç¦»**: JWTæ— çŠ¶æ€è®¤è¯ï¼Œæ”¯æŒå¤šç«¯æ¥å…¥
- **å¾®æœåŠ¡å‹å¥½**: æ— çŠ¶æ€è®¾è®¡ï¼Œæ˜“äºæ°´å¹³æ‰©å±•
- **äº‹ä»¶é©±åŠ¨**: åŸºäºæ¶ˆæ¯çš„å¼‚æ­¥é€šä¿¡

### 2. æ€§èƒ½ä¼˜åŒ–
- **é•¿è¿æ¥**: WebSocketå‡å°‘è¿æ¥å¼€é”€
- **æ¶ˆæ¯ä»£ç†**: Springå†…ç½®æ¶ˆæ¯ä»£ç†ï¼Œé«˜æ•ˆæ¶ˆæ¯åˆ†å‘
- **æ•°æ®åº“ç´¢å¼•**: é€šçŸ¥è¡¨æŒ‰ç”¨æˆ·IDå’Œæ—¶é—´ç´¢å¼•

### 3. å®‰å…¨æœºåˆ¶
- **JWTè®¤è¯**: é˜²æ­¢CSRFæ”»å‡»ï¼Œæ”¯æŒè·¨åŸŸ
- **æƒé™æ§åˆ¶**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- **è¾“å…¥éªŒè¯**: é˜²æ­¢XSSå’ŒSQLæ³¨å…¥

### 4. å¯ç»´æŠ¤æ€§
- **æ¨¡å—åŒ–è®¾è®¡**: åŠŸèƒ½æ¨¡å—æ¸…æ™°åˆ†ç¦»
- **é…ç½®å¤–éƒ¨åŒ–**: æ”¯æŒä¸åŒç¯å¢ƒé…ç½®
- **æ—¥å¿—è®°å½•**: å®Œæ•´çš„æ“ä½œæ—¥å¿—

### 5. ç”¨æˆ·ä½“éªŒ
- **å®æ—¶åé¦ˆ**: å³æ—¶æ¶ˆæ¯æ¨é€
- **ç¦»çº¿æ”¯æŒ**: æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨
- **å¤šç«¯åŒæ­¥**: æ”¯æŒå¤šè®¾å¤‡åŒæ—¶åœ¨çº¿

---

## ğŸ“ˆ æ‰©å±•å»ºè®®

### 1. åŠŸèƒ½æ‰©å±•
- æ·»åŠ æ¶ˆæ¯æ¨¡æ¿ç³»ç»Ÿ
- å®ç°æ¶ˆæ¯æ¨é€ç­–ç•¥é…ç½®
- æ·»åŠ æ¶ˆæ¯ç»Ÿè®¡å’Œåˆ†æ
- æ”¯æŒå¯Œæ–‡æœ¬æ¶ˆæ¯æ ¼å¼

### 2. æ€§èƒ½ä¼˜åŒ–
- å¼•å…¥Redisä½œä¸ºæ¶ˆæ¯ç¼“å­˜
- å®ç°æ¶ˆæ¯é˜Ÿåˆ—æŒä¹…åŒ–
- æ·»åŠ æ¶ˆæ¯å‘é€é™æµæœºåˆ¶
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

### 3. ç›‘æ§å‘Šè­¦
- æ·»åŠ WebSocketè¿æ¥ç›‘æ§
- å®ç°æ¶ˆæ¯å‘é€æˆåŠŸç‡ç»Ÿè®¡
- æ·»åŠ ç³»ç»Ÿå¥åº·æ£€æŸ¥æ¥å£
- é›†æˆAPMç›‘æ§å·¥å…·

### 4. å®‰å…¨å¢å¼º
- å®ç°JWT tokenåˆ·æ–°æœºåˆ¶
- æ·»åŠ APIè®¿é—®é¢‘ç‡é™åˆ¶
- å¢å¼ºWebSocketè¿æ¥å®‰å…¨
- å®ç°æ¶ˆæ¯å†…å®¹åŠ å¯†

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡å®ç°ä¸ºå›¾ä¹¦ç®¡ç†ç³»ç»ŸæˆåŠŸæ·»åŠ äº†å®Œæ•´çš„å®æ—¶é€šçŸ¥å’ŒJWTè®¤è¯åŠŸèƒ½ï¼Œä¸»è¦æˆæœåŒ…æ‹¬ï¼š

âœ… **å®Œæ•´çš„JWTè®¤è¯ç³»ç»Ÿ** - æ”¯æŒç”¨æˆ·ç™»å½•ã€tokenéªŒè¯å’Œæƒé™æ§åˆ¶
âœ… **å®æ—¶WebSocketé€šçŸ¥** - æ”¯æŒä¸ªäººé€šçŸ¥å’Œç³»ç»Ÿå¹¿æ’­
âœ… **ä¸°å¯Œçš„é€šçŸ¥ç±»å‹** - æ–°ä¹¦åˆ°è¾¾ã€å€Ÿé˜…æé†’ã€ç³»ç»Ÿæ¶ˆæ¯ç­‰
âœ… **å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ** - è‡ªåŠ¨æ£€æŸ¥å€Ÿé˜…çŠ¶æ€å’Œå‘é€æé†’
âœ… **å®Œæ•´çš„æµ‹è¯•é¡µé¢** - ä¾¿äºåŠŸèƒ½æµ‹è¯•å’Œæ¼”ç¤º
âœ… **RESTful API** - æ”¯æŒå‰ç«¯é›†æˆå’Œç¬¬ä¸‰æ–¹è°ƒç”¨

è¯¥å®ç°é‡‡ç”¨äº†ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆå’Œæœ€ä½³å®è·µï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ï¼Œèƒ½å¤Ÿæ»¡è¶³å®é™…ç”Ÿäº§ç¯å¢ƒçš„éœ€æ±‚ã€‚ç³»ç»Ÿæ”¯æŒé«˜å¹¶å‘è®¿é—®ï¼Œæä¾›äº†å®Œæ•´çš„å®‰å…¨æœºåˆ¶ï¼Œä¸ºç”¨æˆ·æä¾›äº†ä¼˜ç§€çš„å®æ—¶äº¤äº’ä½“éªŒã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚éœ€è¿›ä¸€æ­¥çš„æŠ€æœ¯æ”¯æŒæˆ–åŠŸèƒ½æ‰©å±•ï¼Œè¯·å‚è€ƒï¼š
- Spring Bootå®˜æ–¹æ–‡æ¡£
- Spring Securityå‚è€ƒæŒ‡å—
- Spring WebSocketæ–‡æ¡£
- JWTå®˜æ–¹è§„èŒƒ

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2025å¹´1æœˆ*
*é¡¹ç›®ç‰ˆæœ¬: v1.0.0*
*æŠ€æœ¯æ ˆ: Spring Boot 3.4.5 + JWT + WebSocket*
