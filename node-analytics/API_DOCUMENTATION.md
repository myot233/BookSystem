# Book Analytics Service API æ–‡æ¡£

## æœåŠ¡æ¦‚è¿°

Book Analytics Service æ˜¯ä¸€ä¸ªåŸºäº Node.js å’Œ Redis çš„å›¾ä¹¦ç®¡ç†ç³»ç»Ÿåˆ†ææœåŠ¡ï¼Œæä¾›å®æ—¶æ•°æ®æ”¶é›†å’Œç»Ÿè®¡æŸ¥è¯¢åŠŸèƒ½ã€‚

- **æœåŠ¡ç«¯å£**: 9999
- **åŸºç¡€URL**: `http://localhost:9999`
- **æ•°æ®å­˜å‚¨**: Redis
- **æ”¯æŒCORS**: æ˜¯

## API æ¥å£åˆ—è¡¨

### ğŸ“Š æ•°æ®æ”¶é›† API

#### 1. æ”¶é›†å€Ÿé˜…äº‹ä»¶
```http
POST /api/collect/borrow
```

**æè¿°**: è®°å½•ç”¨æˆ·å€Ÿé˜…å›¾ä¹¦çš„äº‹ä»¶

**è¯·æ±‚ä½“**:
```json
{
  "bookId": "string",     // å¿…éœ€ - å›¾ä¹¦ID
  "userId": "string",     // å¿…éœ€ - ç”¨æˆ·ID
  "timestamp": "string"   // å¯é€‰ - æ—¶é—´æˆ³
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "å€Ÿé˜…äº‹ä»¶è®°å½•æˆåŠŸ",
  "timestamp": "2024-01-26T10:30:00.000Z"
}
```

**åŠŸèƒ½**:
- æ›´æ–°ä»Šæ—¥å€Ÿé˜…ç»Ÿè®¡
- æ›´æ–°çƒ­é—¨å›¾ä¹¦æ’è¡Œ
- è®°å½•ç”¨æˆ·æ´»åŠ¨
- æ›´æ–°æ€»å€Ÿé˜…ç»Ÿè®¡

---

#### 2. æ”¶é›†å½’è¿˜äº‹ä»¶
```http
POST /api/collect/return
```

**æè¿°**: è®°å½•ç”¨æˆ·å½’è¿˜å›¾ä¹¦çš„äº‹ä»¶

**è¯·æ±‚ä½“**:
```json
{
  "bookId": "string",     // å¿…éœ€ - å›¾ä¹¦ID
  "userId": "string",     // å¿…éœ€ - ç”¨æˆ·ID
  "timestamp": "string"   // å¯é€‰ - æ—¶é—´æˆ³
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "å½’è¿˜äº‹ä»¶è®°å½•æˆåŠŸ",
  "timestamp": "2024-01-26T10:30:00.000Z"
}
```

**åŠŸèƒ½**:
- æ›´æ–°ä»Šæ—¥å½’è¿˜ç»Ÿè®¡
- æ›´æ–°æ€»å½’è¿˜ç»Ÿè®¡

---

#### 3. æ”¶é›†ç”¨æˆ·ç™»å½•äº‹ä»¶
```http
POST /api/collect/login
```

**æè¿°**: è®°å½•ç”¨æˆ·ç™»å½•äº‹ä»¶

**è¯·æ±‚ä½“**:
```json
{
  "userId": "string",     // å¿…éœ€ - ç”¨æˆ·ID
  "username": "string"    // å¯é€‰ - ç”¨æˆ·å
}
```

**å“åº”**:
```json
{
  "success": true,
  "message": "ç”¨æˆ·ç™»å½•äº‹ä»¶è®°å½•æˆåŠŸ",
  "timestamp": "2024-01-26T10:30:00.000Z"
}
```

**åŠŸèƒ½**:
- æ·»åŠ åˆ°åœ¨çº¿ç”¨æˆ·é›†åˆ
- è®°å½•ä»Šæ—¥ç™»å½•ç”¨æˆ·

---

### ğŸ“ˆ ç»Ÿè®¡æŸ¥è¯¢ API

#### 4. è·å–ä»Šæ—¥ç»Ÿè®¡
```http
GET /api/stats/today
```

**æè¿°**: è·å–ä»Šæ—¥çš„å„é¡¹ç»Ÿè®¡æ•°æ®

**å“åº”**:
```json
{
  "date": "2024-01-26",
  "borrows": 15,
  "returns": 8,
  "onlineUsers": 12,
  "dailyLoginUsers": 25,
  "netBorrows": 7
}
```

---

#### 5. è·å–çƒ­é—¨å›¾ä¹¦æ’è¡Œ
```http
GET /api/stats/hot-books?limit=10
```

**æè¿°**: è·å–çƒ­é—¨å›¾ä¹¦æ’è¡Œæ¦œ

**æŸ¥è¯¢å‚æ•°**:
- `limit` (å¯é€‰): è¿”å›æ•°é‡é™åˆ¶ï¼Œé»˜è®¤10

**å“åº”**:
```json
{
  "total": 5,
  "books": [
    {
      "bookId": "123",
      "borrowCount": 25
    },
    {
      "bookId": "456",
      "borrowCount": 18
    }
  ]
}
```

---

#### 6. è·å–æ€»ä½“ç»Ÿè®¡
```http
GET /api/stats/overview
```

**æè¿°**: è·å–ç³»ç»Ÿæ€»ä½“ç»Ÿè®¡ä¿¡æ¯

**å“åº”**:
```json
{
  "totalBorrows": 1250,
  "totalReturns": 1100,
  "currentOnlineUsers": 12,
  "trackedBooks": 150,
  "systemUptime": 86400.5,
  "lastUpdated": "2024-01-26T10:30:00.000Z"
}
```

---

#### 7. è·å–æœ€è¿‘å‡ å¤©ç»Ÿè®¡
```http
GET /api/stats/recent-days?days=7
```

**æè¿°**: è·å–æœ€è¿‘å‡ å¤©çš„ç»Ÿè®¡æ•°æ®

**æŸ¥è¯¢å‚æ•°**:
- `days` (å¯é€‰): å¤©æ•°ï¼Œé»˜è®¤7å¤©

**å“åº”**:
```json
{
  "period": "æœ€è¿‘7å¤©",
  "data": [
    {
      "date": "2024-01-20",
      "borrows": 15,
      "returns": 12,
      "loginUsers": 25
    },
    {
      "date": "2024-01-21",
      "borrows": 18,
      "returns": 14,
      "loginUsers": 28
    }
  ]
}
```

---

### ğŸ”§ ç³»ç»Ÿç®¡ç† API

#### 8. è·å–æœåŠ¡çŠ¶æ€
```http
GET /api/status
```

**æè¿°**: è·å–æœåŠ¡è¿è¡ŒçŠ¶æ€å’Œç³»ç»Ÿä¿¡æ¯

**å“åº”**:
```json
{
  "service": "Book Analytics Service",
  "version": "1.0.0",
  "status": "running",
  "redis": "connected",
  "uptime": 86400.5,
  "memory": {
    "rss": 50331648,
    "heapTotal": 20971520,
    "heapUsed": 15728640,
    "external": 1048576
  },
  "timestamp": "2024-01-26T10:30:00.000Z"
}
```

---

#### 9. æ¸…ç†è¿‡æœŸæ•°æ®
```http
POST /api/admin/cleanup
```

**æè¿°**: æ‰‹åŠ¨æ¸…ç†è¿‡æœŸçš„ç»Ÿè®¡æ•°æ®

**å“åº”**:
```json
{
  "success": true,
  "message": "æ•°æ®æ¸…ç†å®Œæˆï¼Œæ¸…ç†äº† 15 ä¸ªè¿‡æœŸé”®",
  "timestamp": "2024-01-26T10:30:00.000Z"
}
```

---

## ğŸ• å®šæ—¶ä»»åŠ¡

### 1. æ•°æ®æ¸…ç†ä»»åŠ¡
- **æ‰§è¡Œæ—¶é—´**: æ¯å¤©å‡Œæ™¨2ç‚¹
- **åŠŸèƒ½**: æ¸…ç†30å¤©å‰çš„è¿‡æœŸæ•°æ®
- **æ¸…ç†å†…å®¹**: 
  - æ¯æ—¥å€Ÿé˜…ç»Ÿè®¡
  - æ¯æ—¥å½’è¿˜ç»Ÿè®¡
  - æ¯æ—¥ç™»å½•ç”¨æˆ·è®°å½•

### 2. åœ¨çº¿ç”¨æˆ·æ¸…ç†
- **æ‰§è¡Œæ—¶é—´**: æ¯å°æ—¶
- **åŠŸèƒ½**: æ›´æ–°åœ¨çº¿ç”¨æˆ·è¿‡æœŸæ—¶é—´ï¼Œæ¸…ç†ç¦»çº¿ç”¨æˆ·

---

## ğŸ“ é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰APIåœ¨å‘ç”Ÿé”™è¯¯æ—¶éƒ½ä¼šè¿”å›ä»¥ä¸‹æ ¼å¼çš„å“åº”ï¼š

```json
{
  "error": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

å¸¸è§HTTPçŠ¶æ€ç ï¼š
- `200`: æˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## ğŸ”— Redis æ•°æ®ç»“æ„

### é”®åè§„èŒƒ
- `stats:today_borrows:{date}`: ä»Šæ—¥å€Ÿé˜…ç»Ÿè®¡
- `stats:today_returns:{date}`: ä»Šæ—¥å½’è¿˜ç»Ÿè®¡
- `stats:daily_login_users:{date}`: æ¯æ—¥ç™»å½•ç”¨æˆ·é›†åˆ
- `stats:total_borrows`: æ€»å€Ÿé˜…ç»Ÿè®¡
- `stats:total_returns`: æ€»å½’è¿˜ç»Ÿè®¡
- `hot_books`: çƒ­é—¨å›¾ä¹¦æœ‰åºé›†åˆ
- `online_users`: åœ¨çº¿ç”¨æˆ·é›†åˆ
- `active_users`: æ´»è·ƒç”¨æˆ·é›†åˆ

### æ•°æ®è¿‡æœŸç­–ç•¥
- åœ¨çº¿ç”¨æˆ·: 1å°æ—¶
- æ´»è·ƒç”¨æˆ·: 1å°æ—¶
- æ¯æ—¥ç™»å½•ç”¨æˆ·: 7å¤©
- å†å²ç»Ÿè®¡æ•°æ®: 30å¤©åè‡ªåŠ¨æ¸…ç†

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### è®°å½•å€Ÿé˜…äº‹ä»¶
```bash
curl -X POST http://localhost:9999/api/collect/borrow \
  -H "Content-Type: application/json" \
  -d '{
    "bookId": "123",
    "userId": "456",
    "timestamp": "2024-01-26T10:30:00.000Z"
  }'
```

### è·å–ä»Šæ—¥ç»Ÿè®¡
```bash
curl http://localhost:9999/api/stats/today
```

### è·å–çƒ­é—¨å›¾ä¹¦
```bash
curl http://localhost:9999/api/stats/hot-books?limit=5
```
